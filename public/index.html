<!DOCTYPE html>
<html lang="am" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>á‰¢áŠ•áŒ áŠ¢á‰µá‹®áŒµá‹« (Bingo Ethio) TWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans Ethiopic', sans-serif; 
            touch-action: manipulation; 
            /* TWA Optimization: Remove vertical scrollbar and blend into Telegram background */
            background-color: #f0f0f0; 
        }
        .bingo-cell { aspect-ratio: 1; }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        .pop-in { animation: popIn 0.3s ease-out forwards; }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

        /* Custom styles for TWA feel */
        .twa-header { background-color: #5593e3; } /* Telegram Blue */
    </style>
</head>
<body class="text-gray-900 h-screen flex flex-col">

    <!-- Main App Container -->
    <div id="app" class="flex-1 flex flex-col max-w-md mx-auto w-full bg-white shadow-xl h-full overflow-hidden relative">
        
        <!-- Header (TWA Style) -->
        <header class="twa-header text-white p-3 flex justify-between items-center shadow-md z-10">
            <h1 class="text-lg font-bold flex items-center">
                <span class="text-yellow-300 mr-1">â˜…</span> á‰¢áŠ•áŒ áŠ¢á‰µá‹®áŒµá‹« (TWA)
            </h1>
            <div id="user-balance-display" class="hidden text-sm bg-blue-700 px-3 py-1 rounded-full">
                0 á‰¥áˆ­
            </div>
        </header>

        <!-- Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto p-4 relative bg-gray-50">
             <!-- Loading Screen -->
             <div id="loading-screen" class="absolute inset-0 bg-white flex items-center justify-center z-50">
                <div class="text-center animate-pulse">
                    <p class="text-xl font-bold text-blue-600">á‰ áˆ˜áŒ«áŠ• áˆ‹á‹­...</p>
                    <p class="text-gray-500 text-sm">(Loading...)</p>
                </div>
            </div>

            <!-- Login/Welcome Screen (Simulating TWA initialization for first-time user) -->
            <div id="login-screen" class="hidden flex flex-col items-center justify-center h-full space-y-6">
                <div class="text-center space-y-2">
                    <h2 class="text-3xl font-bold text-blue-700">áŠ¥áŠ•áŠ³áŠ• á‹°áˆ…áŠ“ áˆ˜áŒ¡!</h2>
                    <p class="text-gray-600">á‹­áˆ…áŠ•áŠ• áˆ˜á‰°áŒá‰ áˆªá‹« áˆˆáˆ˜áŒ á‰€áˆ áˆµáˆá‹áŠ• á‹«áˆµáŒˆá‰¡á¢</p>
                </div>
                <div class="w-full max-w-xs space-y-4">
                    <input type="text" id="username-input" placeholder="áˆ˜áŒ á‰€áˆšá‹« áˆµáˆ (Username)" class="w-full px-4 py-3 border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 text-center text-lg">
                    <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition transform active:scale-95">
                        áŒá‰£ (Enter)
                    </button>
                    <p class="text-xs text-gray-500 mt-2">á‹¨á‰´áˆŒáŒáˆ«áˆ áˆ˜áˆˆá‹«á‹ áˆˆáŒ¨á‹‹á‰³ áˆ˜áˆˆá‹«á‹áŠá‰µ á‹«áŒˆáˆˆáŒáˆ‹áˆá¢</p>
                </div>
            </div>

            <!-- Main Menu Dashboard -->
            <div id="dashboard-screen" class="hidden space-y-6">
                <div class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded-r-lg shadow-sm">
                    <h3 class="font-bold text-lg mb-1">áˆ°áˆ‹áˆ, <span id="dash-username"></span>!</h3>
                    <p class="text-sm text-gray-600">á‹¨áŠ áˆáŠ• á‰€áˆª áˆ‚áˆ³á‰¥á‹: <span id="dash-balance" class="font-bold text-blue-700 text-xl">0</span> á‰¥áˆ­</p>
                    <p class="text-xs text-gray-500 mt-1">áˆ˜áˆˆá‹« áˆ˜áˆˆá‹« á‰áŒ¥áˆ­: <span id="user-id-display" class="font-mono text-gray-800"></span></p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button id="play-btn" class="col-span-2 bg-gradient-to-r from-blue-500 to-blue-700 text-white p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center transform transition active:scale-95">
                        <span class="text-4xl mb-2">ğŸ®</span>
                        <span class="text-2xl font-bold">áŠ áˆáŠ• á‰°áŒ«á‹ˆá‰µ</span>
                        <span class="text-sm opacity-90">Play Bingo (50 á‰¥áˆ­)</span>
                    </button>
                    <button onclick="showWallet('deposit')" class="bg-yellow-500 text-white p-4 rounded-xl shadow-md flex flex-col items-center active:bg-yellow-600">
                        <span class="text-2xl">ğŸ“¥</span>
                        <span class="font-bold">áŒˆáŠ•á‹˜á‰¥ áŠ áˆµáŒˆá‰£</span>
                        <span class="text-xs">(Deposit)</span>
                    </button>
                    <button onclick="showWallet('withdraw')" class="bg-red-500 text-white p-4 rounded-xl shadow-md flex flex-col items-center active:bg-red-600">
                        <span class="text-2xl">ğŸ“¤</span>
                        <span class="font-bold">áŒˆáŠ•á‹˜á‰¥ áŠ á‹áŒ£</span>
                        <span class="text-xs">(Withdraw)</span>
                    </button>
                </div>

                <div class="mt-8">
                     <h4 class="font-bold text-gray-700 mb-2 border-b pb-2">á‹¨áŒá‰¥á‹­á‰µ á‰³áˆªáŠ­ (History)</h4>
                     <ul id="tx-history" class="text-sm text-gray-500 max-h-32 overflow-y-auto">
                         <li class="py-1">áˆáŠ•áˆ á‰³áˆªáŠ­ á‹¨áˆˆáˆ (No history)</li>
                     </ul>
                </div>
            </div>

            <!-- Lobby Screen -->
            <div id="lobby-screen" class="hidden flex flex-col items-center justify-center h-full space-y-6 text-center">
                <div class="animate-spin text-5xl text-blue-500">â³</div>
                <div>
                    <h2 class="text-2xl font-bold text-blue-700 mb-2">á‰°áŒ«á‹‹á‰¾á‰½áŠ• á‰ áˆ˜áŒ á‰ á‰… áˆ‹á‹­...</h2>
                    <p class="text-gray-600">(Waiting for players)</p>
                </div>
                <div class="bg-yellow-100 text-yellow-800 px-6 py-3 rounded-full font-mono text-xl">
                    <span id="player-count">1</span> / <span id="min-players">10</span>
                </div>
                <p class="text-sm text-gray-500 max-w-xs">áŒ¨á‹‹á‰³á‹ á‹¨áˆšáŒ€áˆáˆ¨á‹ 10 á‰°áŒ«á‹‹á‰¾á‰½ áˆ²áŒˆá‰¡ áŠá‹</p>
                <button id="leave-lobby-btn" class="mt-8 text-red-500 underline">á‹áŒ£ (Leave Lobby)</button>
            </div>

            <!-- Game Screen -->
            <div id="game-screen" class="hidden flex flex-col h-full">
                <!-- Top info bar -->
                <div class="flex justify-between items-center mb-2 text-sm">
                    <div class="bg-gray-200 px-2 py-1 rounded">á‰°áŒ«á‹‹á‰¾á‰½: <span id="game-player-count">0</span></div>
                    <div class="font-bold text-blue-600" id="game-status-txt">áŒ¨á‹‹á‰³á‹ áŠ¥á‹¨áˆ„á‹° áŠá‹...</div>
                </div>

                <!-- Last called number display -->
                <div class="flex flex-col items-center justify-center bg-gray-800 text-white rounded-xl p-4 mb-4 shadow-inner">
                    <span class="text-sm text-gray-400 mb-1">á‹¨á‰°áŒ áˆ« á‰áŒ¥áˆ­ (Current Call)</span>
                    <div id="current-ball" class="text-5xl font-bold font-mono text-yellow-400 h-16 transition-all">-</div>
                </div>

                <!-- Last 5 calls -->
                <div class="mb-4 overflow-x-auto">
                    <div class="flex space-x-2 justify-center" id="previous-balls">
                        <!-- Balls go here -->
                    </div>
                </div>

                <!-- BINGO CARD -->
                <div class="flex-1 flex flex-col justify-center">
                    <div class="grid grid-cols-5 gap-1 bg-blue-700 p-2 rounded-xl shadow-2xl mx-auto max-w-xs w-full aspect-square">
                        <!-- Headers -->
                        <div class="text-center font-bold text-white bg-blue-800 rounded flex items-center justify-center">B</div>
                        <div class="text-center font-bold text-white bg-blue-800 rounded flex items-center justify-center">I</div>
                        <div class="text-center font-bold text-white bg-blue-800 rounded flex items-center justify-center">N</div>
                        <div class="text-center font-bold text-white bg-blue-800 rounded flex items-center justify-center">G</div>
                        <div class="text-center font-bold text-white bg-blue-800 rounded flex items-center justify-center">O</div>
                        
                        <!-- 25 Grid Cells generated by JS -->
                        <div id="bingo-grid" class="contents"></div>
                    </div>
                </div>

                <!-- Bingo Button -->
                <button id="claim-bingo-btn" disabled class="mt-4 bg-gray-400 text-white text-2xl font-bold py-4 rounded-xl shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed w-full animate-bounce">
                    á‰¢áŠ•áŒ! (BINGO!)
                </button>
            </div>

             <!-- Wallet Modal -->
             <div id="wallet-modal" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
                <div class="bg-white w-full max-w-md p-6 rounded-t-2xl sm:rounded-2xl space-y-4 animate-slide-up">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="wallet-title" class="text-xl font-bold">áŒˆáŠ•á‹˜á‰¥ áˆ›áˆµáŒˆá‰¢á‹« (Deposit)</h3>
                        <button onclick="closeModal('wallet-modal')" class="text-gray-500 text-2xl">&times;</button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">
                        áŒˆáŠ•á‹˜á‰¥ áˆˆáˆ›áˆµáŒˆá‰£á‰µ á‹ˆá‹­áˆ áˆˆáˆ›á‹áŒ£á‰µ áˆˆAdmin áˆ˜áˆáŠ¥áŠ­á‰µ á‹­áˆ‹áŠ©á¢ (Manual request sent to admin).
                    </p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">áˆ˜áŒ áŠ• (Amount in ETB)</label>
                            <input type="number" id="wallet-amount" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-0 text-xl" placeholder="50 - 1000">
                        </div>
                        <button id="wallet-submit-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg">
                            áŒ¥á‹«á‰„ áŠ á‰…áˆ­á‰¥ (Submit Request)
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Notification Toast -->
        <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 opacity-0 pointer-events-none text-sm">
            Notification
        </div>
    </div>

<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, addDoc, runTransaction, arrayUnion, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Configuration & Constants ---
    const MIN_PLAYERS = 10;
    const MAX_PLAYERS = 500;
    const ENTRY_FEE = 50;
    const WIN_CONDITION_ROWS = 2; 

    // =======================================================================
    // ğŸ”¥ CRITICAL: PASTE YOUR FIREBASE CONFIGURATION HERE
    // Replace the entire object below with the keys you copied from the 
    // "Project settings" -> "Your apps" section of the Firebase Console.
    // NOTE: This config is safe to be public as it only contains non-secret API keys.
    // =======================================================================
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY_HERE", 
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID_HERE"
    };
    
    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Use the projectId as a safe base for the main app container ID
    const appId = firebaseConfig.projectId;

    // Global State
    let currentUser = null;
    let userProfile = null;
    let currentGameId = null;
    let currentGameUnsubscribe = null;
    let myBingoCard = [];
    let myMarkedIndices = new Set();
    let drawnNumbersSet = new Set();
    let isHost = false;
    let drawInterval = null;

    // --- DOM Elements ---
    const screens = {
        loading: document.getElementById('loading-screen'),
        login: document.getElementById('login-screen'),
        dashboard: document.getElementById('dashboard-screen'),
        lobby: document.getElementById('lobby-screen'),
        game: document.getElementById('game-screen')
    };

    // --- core: Navigation & UI ---
    function showScreen(screenName) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
    }

    function showToast(msg, isError = false) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        // Use Telegram-like colors
        const colorClass = isError ? 'bg-red-600 text-white' : 'bg-blue-600 text-white';
        toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl z-50 transition-all duration-300 text-sm ${colorClass} opacity-100`;
        setTimeout(() => { toast.classList.replace('opacity-100', 'opacity-0'); }, 3000);
    }

    // --- core: Auth & Profile ---
    async function initializeAuth() {
        showScreen('loading');
        // On a public hosted TWA, we use Anonymous Sign-in.
        try {
            await signInAnonymously(auth); 
        } catch (e) {
            console.error("Anonymous sign-in failed:", e);
            showToast("Initialization Failed: Check Firebase Keys", true);
            showScreen('login');
        }
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await loadUserProfile();
        } else {
            console.warn("Auth state changed to logged out. Re-initializing.");
            showScreen('login');
        }
    });

    // Start auth process immediately
    initializeAuth();

    async function loadUserProfile() {
        if (!currentUser) return;
        // Private User Collection Path: artifacts/{appId}/users/{userId}/profile/main
        const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
        try {
            const snap = await getDoc(userRef);
            if (snap.exists()) {
                userProfile = snap.data();
                updateDashboardUI();
                showScreen('dashboard');
            } else {
                // If profile doesn't exist, prompt for creation 
                showScreen('login');
            }
        } catch (e) {
            console.error("Profile load error (User ID: " + currentUser.uid + "):", e);
            showToast("Profile load failed: " + e.message, true);
            showScreen('login');
        }
    }

    document.getElementById('login-btn').addEventListener('click', async () => {
        const username = document.getElementById('username-input').value.trim();
        if (username.length < 3) { showToast("áˆµáˆ á‰¢á‹«áŠ•áˆµ 3 áˆ†áˆ„ áˆ˜áˆ†áŠ• áŠ áˆˆá‰ á‰µ (Name too short)", true); return; }
        
        screens.loading.classList.remove('hidden');
        try {
            // Create the initial profile document
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                username: username,
                balance: 500, // Starting balance
                createdAt: serverTimestamp(),
                telegramId: currentUser.uid // For identification, though this is the anonymous UID
            });
            await loadUserProfile();
        } catch (e) {
            console.error("Profile create error:", e);
            showToast("Error creating profile: " + e.message, true);
            screens.loading.classList.add('hidden');
        }
    });

    function updateDashboardUI() {
        if (!userProfile) return;
        document.getElementById('dash-username').textContent = userProfile.username;
        document.getElementById('dash-balance').textContent = userProfile.balance;
        document.getElementById('user-balance-display').textContent = `${userProfile.balance} á‰¥áˆ­`;
        document.getElementById('user-balance-display').classList.remove('hidden');
        // Mandatory display of full User ID for multi-user coordination
        document.getElementById('user-id-display').textContent = currentUser.uid;
    }

    // --- feature: Wallet (Manual Requests) ---
    window.showWallet = (type) => {
        const modal = document.getElementById('wallet-modal');
        const title = document.getElementById('wallet-title');
        
        modal.dataset.type = type; 
        title.textContent = type === 'deposit' ? 'áŒˆáŠ•á‹˜á‰¥ áˆ›áˆµáŒˆá‰¢á‹« (Deposit)' : 'áŒˆáŠ•á‹˜á‰¥ áˆ›á‹áŒ« (Withdraw)';
        document.getElementById('wallet-amount').value = '';
        modal.classList.remove('hidden');
    };

    window.closeModal = (id) => {
        document.getElementById(id).classList.add('hidden');
    };

    document.getElementById('wallet-submit-btn').addEventListener('click', async (e) => {
        const modal = document.getElementById('wallet-modal');
        const type = modal.dataset.type;
        const amountStr = document.getElementById('wallet-amount').value;
        const amount = parseInt(amountStr);

        if (isNaN(amount) || amount < 50 || amount > 1000) {
             showToast("áˆ˜áŒ áŠ• áŠ¨ 50 áŠ¥áˆµáŠ¨ 1000 á‰¥áˆ­ áˆ˜áˆ†áŠ• áŠ áˆˆá‰ á‰µ (Amount must be 50-1000)", true);
             return;
        }

        if (type === 'withdraw' && userProfile.balance < amount) {
            showToast("á‰ á‰‚ á‰€áˆª áˆ‚áˆ³á‰¥ á‹¨áˆˆá‹á‰µáˆ (Insufficient balance)", true);
            return;
        }

        closeModal('wallet-modal');
        showToast("áŒ¥á‹«á‰„á‹ á‰°áˆáŠ³áˆ! (Request sent)");

        // Transaction requests go into a Public collection for the admin bot to pick up
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                userId: currentUser.uid,
                username: userProfile.username,
                type: type,
                amount: amount,
                status: 'pending',
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Transaction error (Public):", e);
            showToast("á‰½áŒáˆ­ á‰°áˆáŒ¥áˆ¯áˆ (Error sending request)", true);
        }
    });


    // --- feature: Bingo Game Logic ---
    // Public Game Collection Path: artifacts/{appId}/public/data/games

    async function createNewGame(gamesRef) {
        // NOTE: Bingo card generation happens at the initGameScreen step, not here.
        const gameDoc = await addDoc(gamesRef, {
            status: 'waiting',
            hostId: currentUser.uid,
            players: [],
            drawnNumbers: [],
            createdAt: serverTimestamp(),
            winner: null
        });
        currentGameId = gameDoc.id;
        isHost = true;
        await joinGame(currentGameId);
    }

    document.getElementById('play-btn').addEventListener('click', async () => {
        if (!currentUser || !userProfile) { showToast("áŠ¥á‰£áŠ­á‹ á‹­áŒá‰¡ (Please login first)", true); return; }
        if (userProfile.balance < ENTRY_FEE) { showToast(`áˆˆáˆ˜áŒ«á‹ˆá‰µ ${ENTRY_FEE} á‰¥áˆ­ á‹«áˆµáˆáˆáŒ‹áˆ (Need ${ENTRY_FEE} ETB to play)`, true); return; }

        showScreen('loading');

        try {
            // Ensure parent public/data doc exists.
             try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data'), { _init: true }, { merge: true }); } catch (e) { /* ignore */ }

            const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
            
            // Try standard matchmaking query (without orderBy)
            try {
                const q = query(gamesRef, where('status', '==', 'waiting'), limit(1));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    currentGameId = snapshot.docs[0].id;
                    await joinGame(currentGameId);
                } else {
                    await createNewGame(gamesRef);
                }
            } catch (queryError) {
                // If query fails (e.g., index missing, common in new Firestore apps)
                console.warn("Matchmaking query failed (FirebaseError), attempting direct create:", queryError);
                await createNewGame(gamesRef);
            }

        } catch (e) {
            // Catches write errors from createNewGame/joinGame
            console.error("Fatal matchmaking error:", e);
            showToast("Error starting game: " + e.message, true);
            showScreen('dashboard');
        }
    });

    async function joinGame(gameId) {
        const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
        
        try {
            await runTransaction(db, async (transaction) => {
                const gameDoc = await transaction.get(gameRef);
                if (!gameDoc.exists()) throw new Error("Game not found");
                const data = gameDoc.data();
                
                if (data.status !== 'waiting') throw new Error("Game already started");
                if (data.players.includes(currentUser.uid)) throw new Error("Already joined.");
                if (data.players.length >= MAX_PLAYERS) throw new Error("Game full");
                
                // Deduct entry fee
                const userProfileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
                const userSnap = await transaction.get(userProfileRef);
                if (userSnap.data().balance < ENTRY_FEE) throw new Error("Insufficient balance");
                
                transaction.update(gameRef, {
                    players: arrayUnion(currentUser.uid)
                });
                
                // Update user profile balance in transaction
                transaction.update(userProfileRef, {
                    balance: userSnap.data().balance - ENTRY_FEE
                });
            });

            // Update local balance and UI after successful transaction
            userProfile.balance -= ENTRY_FEE;
            updateDashboardUI();

            subscribeToGame(gameId);

        } catch (e) {
            console.error("Join game error:", e);
            showToast("áŒ¨á‹‹á‰³á‹áŠ• áˆ˜á‰€áˆ‹á‰€áˆ áŠ áˆá‰°á‰»áˆˆáˆ (Cannot join): " + e.message, true);
            showScreen('dashboard');
        }
    }

    function subscribeToGame(gameId) {
        if (currentGameUnsubscribe) currentGameUnsubscribe();

        currentGameUnsubscribe = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), (docSnap) => {
            if (!docSnap.exists()) { leaveGame(); return; }
            const data = docSnap.data();

            if (data.status === 'waiting') {
                showScreen('lobby');
                document.getElementById('player-count').textContent = data.players.length;
                document.getElementById('min-players').textContent = MIN_PLAYERS;
                
                // Host logic (to be replaced by a secure backend later)
                if (isHost && data.players.length >= MIN_PLAYERS) {
                    startGameAsHost(gameId);
                }
            } else if (data.status === 'active') {
                if (document.getElementById('game-screen').classList.contains('hidden')) {
                    initGameScreen();
                }
                updateGamePlay(data);
            } else if (data.status === 'finished') {
                endGame(data);
            }
        }, (error) => {
             console.error("Game subscription error:", error);
             showToast("Game connection lost", true);
             leaveGame();
        });
    }

    async function startGameAsHost(gameId) {
        if (!isHost) return;
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                status: 'active',
                startedAt: serverTimestamp()
            });
            startNumberDrawLoop(gameId);
        } catch (e) {
            console.error("Host failed to start game", e);
        }
    }

    function startNumberDrawLoop(gameId) {
        if (drawInterval) clearInterval(drawInterval);
        // NOTE: This drawing logic MUST be moved to a secure backend server (Cloud Function)
        // for production security and fairness.
        drawInterval = setInterval(async () => {
             const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
             try {
                 const snap = await getDoc(gRef);
                 if (!snap.exists() || snap.data().status !== 'active') {
                     clearInterval(drawInterval); return;
                 }
                 
                 const drawn = snap.data().drawnNumbers || [];
                 if (drawn.length >= 75) { clearInterval(drawInterval); return; }

                 let nextNum;
                 do {
                     nextNum = Math.floor(Math.random() * 75) + 1;
                 } while (drawn.includes(nextNum));

                 await updateDoc(gRef, {
                     drawnNumbers: arrayUnion(nextNum)
                 });
             } catch (e) {
                 console.warn("Draw loop error (retrying next tick):", e);
             }
        }, 4000); 
    }

    function initGameScreen() {
        showScreen('game');
        generateBingoCard();
        renderBingoCard();
        myMarkedIndices.clear();
        drawnNumbersSet.clear();
        document.getElementById('claim-bingo-btn').disabled = true;
        document.getElementById('claim-bingo-btn').classList.remove('bg-blue-600', 'hover:bg-blue-700', 'animate-pulse');
        document.getElementById('claim-bingo-btn').classList.add('bg-gray-400');
    }

    function generateBingoCard() {
        // B(1-15), I(16-30), N(31-45), G(46-60), O(61-75)
        const cols = {
            'B': generateRandomSet(1, 15, 5),
            'I': generateRandomSet(16, 30, 5),
            'N': generateRandomSet(31, 45, 4), // N column has 4 non-free numbers
            'G': generateRandomSet(46, 60, 5),
            'O': generateRandomSet(61, 75, 5)
        };

        myBingoCard = [];
        let nIndex = 0;
        for (let r = 0; r < 5; r++) {
            myBingoCard.push(cols['B'][r]);
            myBingoCard.push(cols['I'][r]);
            if (r === 2) {
                 myBingoCard.push('FREE'); // Center slot
            } else {
                myBingoCard.push(cols['N'][nIndex++]);
            }
            myBingoCard.push(cols['G'][r]);
            myBingoCard.push(cols['O'][r]);
        }
    }

    function generateRandomSet(min, max, count) {
        const nums = new Set();
        while(nums.size < count) {
            nums.add(Math.floor(Math.random() * (max - min + 1)) + min);
        }
        return Array.from(nums);
    }

    function renderBingoCard() {
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = '';
        myBingoCard.forEach((num, index) => {
            const cell = document.createElement('div');
            cell.className = `bingo-cell relative flex items-center justify-center bg-gray-100 border-2 border-blue-200 rounded-lg font-bold text-lg sm:text-xl ${num === 'FREE' ? 'bg-yellow-200 text-yellow-800' : 'text-gray-800'}`;
            
            if (num === 'FREE') {
                cell.textContent = 'â˜…';
                myMarkedIndices.add(index);
                // Mark the free space as blue immediately
                cell.classList.add('bg-blue-300', 'border-blue-500'); 
            } else {
                cell.textContent = num;
                cell.dataset.index = index;
                cell.dataset.number = num;
                cell.onclick = () => handleCellClick(index, num, cell);
            }
            cell.id = `cell-${index}`;
            grid.appendChild(cell);
        });
    }

    function updateGamePlay(data) {
        document.getElementById('game-player-count').textContent = data.players.length;
        
        const newDrawn = data.drawnNumbers || [];
        if (newDrawn.length > drawnNumbersSet.size) {
            const lastNum = newDrawn[newDrawn.length - 1];
            
            const currentBallEl = document.getElementById('current-ball');
            currentBallEl.classList.remove('pop-in');
            void currentBallEl.offsetWidth; // Force reflow for animation reset
            currentBallEl.textContent = lastNum;
            currentBallEl.classList.add('pop-in');

            // Update previous calls display
            const prevContainer = document.getElementById('previous-balls');
            const ball = document.createElement('div');
            ball.className = 'w-8 h-8 flex-shrink-0 bg-white text-gray-800 rounded-full flex items-center justify-center font-bold text-sm border border-gray-300 shadow-sm';
            ball.textContent = lastNum;
            prevContainer.prepend(ball);
            // Keep only the last 5
            while(prevContainer.children.length > 5) {
                prevContainer.removeChild(prevContainer.lastChild);
            }

            drawnNumbersSet.add(lastNum);
        }
    }

    function handleCellClick(index, num, cellEl) {
        // Only mark if the number has been drawn
        if (drawnNumbersSet.has(parseInt(num))) { 
            if (!myMarkedIndices.has(index)) {
                myMarkedIndices.add(index);
                cellEl.classList.add('bg-blue-500', 'text-white', 'border-blue-700', 'pop-in');
                checkForWin();
            }
        } else {
             // Flash red if they try to mark a number that hasn't been called
             cellEl.classList.add('animate-pulse', 'bg-red-100');
             showToast("á‹­áˆ… á‰áŒ¥áˆ­ áŠ áˆá‰°áŒ áˆ«áˆ! (Number not called yet!)", true);
             setTimeout(() => cellEl.classList.remove('animate-pulse', 'bg-red-100'), 500);
        }
    }

    function checkForWin() {
        // Winning patterns: 2 full horizontal rows
        let completedRows = 0;
        const rows = [
            [0, 1, 2, 3, 4],
            [5, 6, 7, 8, 9],
            [10, 11, 12, 13, 14],
            [15, 16, 17, 18, 19],
            [20, 21, 22, 23, 24]
        ];

        for (const row of rows) {
            let rowComplete = true;
            for (const index of row) {
                if (!myMarkedIndices.has(index)) {
                    rowComplete = false;
                    break;
                }
            }
            if (rowComplete) completedRows++;
        }


        if (completedRows >= WIN_CONDITION_ROWS) {
            const btn = document.getElementById('claim-bingo-btn');
            if (btn.disabled) { // Only enable and animate once
                btn.disabled = false;
                btn.classList.remove('bg-gray-400');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'animate-pulse');
                btn.textContent = "á‰¢áŠ•áŒ! (BINGO!) - Click to Claim!";
                showToast("BINGO ready! Claim your win!");
            }
        }
    }

    document.getElementById('claim-bingo-btn').addEventListener('click', async () => {
        if (!currentGameId || document.getElementById('claim-bingo-btn').disabled) return;
        
        // Disable button immediately to prevent double-click
        document.getElementById('claim-bingo-btn').disabled = true;

        try {
            await runTransaction(db, async (transaction) => {
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId);
                const gameDoc = await transaction.get(gameRef);
                const gameData = gameDoc.data();

                if (gameData.status === 'finished') throw new Error("Game already over. Too late!");
                
                // Set the game status to finished with the winner ID
                transaction.update(gameRef, {
                    status: 'finished',
                    winner: currentUser.uid,
                    winnerName: userProfile.username,
                    finishedAt: serverTimestamp()
                });
                
                // Payout simulation (Actual payout should be server-side)
                const potentialWinnings = (gameData.players.length * ENTRY_FEE * 0.9);
                const userProfileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
                const userSnap = await transaction.get(userProfileRef);
                const newBalance = userSnap.data().balance + potentialWinnings;

                // Update user profile balance in transaction
                transaction.update(userProfileRef, {
                    balance: newBalance
                });
            });

            // If transaction succeeds, update local state
            showToast("á‰¢áŠ•áŒá‹ á‰°á‰€á‰£á‹­áŠá‰µ áŠ áŒáŠá‰·áˆ! (Bingo Claim Accepted!)", false);
            leaveGame();

        } catch (e) {
            showToast("Claim failed (Try again): " + e.message, true);
            // Force game exit to reload the dashboard state
            leaveGame(); 
        }
    });

    function endGame(data) {
        if (drawInterval) clearInterval(drawInterval);
        
        // Use a simple non-blocking alert for end-of-game modal
        let msg = '';
        if (data.winner === currentUser.uid) {
            msg = `ğŸ‰ áŠ¥áŠ•áŠ³áŠ• á‹°áˆµ áŠ áˆˆá‹á‰µ! áŠ áˆ¸áŠ•áˆá‹‹áˆ!`;
        } else {
            msg = `áŒ¨á‹‹á‰³á‹ áŠ áˆá‰‹áˆ! áŠ áˆ¸áŠ“áŠ: ${data.winnerName || 'Another Player'}`;
        }
        
        alert(msg); 
        leaveGame();
    }

    function leaveGame() {
        if (currentGameUnsubscribe) currentGameUnsubscribe();
        if (drawInterval) clearInterval(drawInterval);
        currentGameId = null;
        isHost = false;
        document.getElementById('previous-balls').innerHTML = '';
        document.getElementById('current-ball').textContent = '-';
        showScreen('dashboard');
        loadUserProfile(); // Re-sync profile to get actual final balance
    }

    document.getElementById('leave-lobby-btn').addEventListener('click', async () => {
        if (currentGameId) {
             leaveGame();
        }
    });

</script>
</body>
</html>
